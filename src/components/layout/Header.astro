---
// Shared header component
---

<header class="site">
  <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
    <div class="brand">
      <a href="/" style="text-decoration:none; color:inherit;">
        <div class="brand__name"><em>Elfa</em> Publikacje</div>
      </a>
    </div>
    <button class="nav-toggle" aria-controls="nav-main" aria-expanded="false" aria-label="Menu">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 6h18M3 12h18M3 18h18"/>
      </svg>
    </button>
    <nav id="nav-main" class="main-nav" aria-label="Główne">
      <a href="/oferta">Oferta</a>
      <a href="/realizacje">Realizacje</a>
      <a href="/blog">Blog</a>
      <a href="/#kontakt">Kontakt</a>
    </nav>
  </div>
</header>

<style is:global>
  header.site{
    --ink:#2a2a2a;
    --ink-soft:#4b4b4b;
    --accent:#b68b3c;
    --accent-ink:#6a521f;
    --rule:#e8e0d6;
    --shadow:0 10px 30px rgba(0,0,0,.06);
  }

  .wrap{max-width:78ch; margin-inline:auto; padding:clamp(16px,5vw,28px)}

  header.site{
    position:sticky; top:0; z-index:5; backdrop-filter:saturate(140%) blur(6px);
    background:var(--bg);
    border-bottom:1px solid var(--rule);

    /* Break out of constrained parent (blog pages) to match homepage */
    position: sticky;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    box-sizing: border-box;
  }
  .brand{display:flex; gap:.8rem; align-items:center;}
  .brand__name{font-size:1.25rem; font-weight:600}
  header.site .wrap{position:relative}

  /* Nawigacja */
  .nav-toggle{
    display:none;
    background:none;
    border:none;
    padding:8px;
    cursor:pointer;
    line-height:0;
  }
  .nav-toggle svg{
    width:28px; height:28px;
    stroke:var(--ink);
    stroke-width:2;
    fill:none;
  }
  .nav-toggle svg path{ stroke-linecap:round; }

  nav.main-nav{display:flex; align-items:center; gap:1.2rem}
  nav.main-nav a{
    color:var(--ink-soft);
    text-decoration:none;
    letter-spacing:.06em;
    font-variant-caps: all-small-caps;
    font-size:1.05rem;
    position:relative;
    padding-bottom:2px;
  }
  nav.main-nav a::after{
    content:'';
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    height:1px;
    background:var(--ink);
    transform:scaleX(0);
    transition:transform .2s ease;
  }
  nav.main-nav a:hover{color:var(--ink)}
  nav.main-nav a:hover::after{transform:scaleX(1)}

  @media(max-width:899px){
    .nav-toggle{display:inline-flex}
    nav.main-nav{
      position:absolute; right:0; top:calc(100% + 8px);
      background:var(--bg); border:1px solid var(--rule); border-radius:12px;
      padding:.5rem; box-shadow:var(--shadow);
      flex-direction:column; align-items:flex-start; gap:.2rem; min-width:220px;
      overflow:visible; white-space:normal; opacity:0; visibility:hidden;
      transform:translateY(-6px); transition:.2s ease;
    }
    nav.main-nav.open{opacity:1; visibility:visible; transform:translateY(0)}
    nav.main-nav a{padding:.6rem .4rem; font-size:1rem}
  }
</style>

<script is:inline>
  // Menu mobilne
  // NOTE: With Astro view transitions, `DOMContentLoaded` won't fire on client-side
  // navigations. Use `astro:page-load` to (re)bind after each swap.

  function getHeaderNavElements() {
    const header = document.querySelector('header.site');
    const btn = header?.querySelector('.nav-toggle');
    const nav = header?.querySelector('#nav-main');
    return { header, btn, nav };
  }

  function closeMobileNav() {
    const { btn, nav } = getHeaderNavElements();
    if (!btn || !nav) return;
    nav.classList.remove('open');
    btn.setAttribute('aria-expanded', 'false');
  }

  function setupMobileNav() {
    const { btn, nav } = getHeaderNavElements();
    if (!btn || !nav) return;

    // Bind click handler once per button instance
    if (btn.dataset.navBound === 'true') return;
    btn.dataset.navBound = 'true';

    btn.addEventListener('click', () => {
      const { btn: currentBtn, nav: currentNav } = getHeaderNavElements();
      if (!currentBtn || !currentNav) return;
      const open = currentNav.classList.toggle('open');
      currentBtn.setAttribute('aria-expanded', String(open));
    });

    // Ensure correct ARIA state after swaps
    btn.setAttribute('aria-expanded', nav.classList.contains('open') ? 'true' : 'false');

    // Global close handlers (bind once)
    if (window.__elfaMobileNavGlobalBound) return;
    window.__elfaMobileNavGlobalBound = true;

    document.addEventListener('click', (e) => {
      const { btn, nav } = getHeaderNavElements();
      if (!btn || !nav) return;
      const target = e.target;
      if (
        nav.classList.contains('open') &&
        target instanceof Node &&
        !nav.contains(target) &&
        !btn.contains(target)
      ) {
        closeMobileNav();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeMobileNav();
    });

    document.addEventListener('astro:before-swap', () => {
      closeMobileNav();
    });
  }

  document.addEventListener('astro:page-load', setupMobileNav);
  document.addEventListener('DOMContentLoaded', setupMobileNav);
</script>
